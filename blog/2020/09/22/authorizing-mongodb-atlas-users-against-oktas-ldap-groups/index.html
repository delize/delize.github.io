<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Authorizing MongoDB Atlas users against Okta's LDAP Groups</title>
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="author" content="Andrew Doering" />
<meta name="ROBOTS" content="">
        <!--  Custom Style CSS  -->
<link rel="stylesheet" href=https://andrewdoering.org/assets/css/style-post.css>
        <!--  Custom Style CSS  -->
<link rel="stylesheet" href=https://andrewdoering.org/assets/css/style-blog.css>
        <!--  FavIcon  -->
<link rel="apple-touch-icon" sizes="180x180" href="https://andrewdoering.org/assets/favicon//apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://andrewdoering.org/assets/favicon//favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="https://andrewdoering.org/assets/favicon//favicon-16x16.png" />
<link rel="manifest" href="https://andrewdoering.org/assets/favicon/site.webmanifest">

<!-- Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli:300,400,600%7CPoppins:400,500,600,700" />

<!--  Bootstrap CSS  -->
<!-- <link rel="stylesheet" href="https://andrewdoering.org/assets/css/bootstrap.css" /> -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/bootstrap.min.css" />
<!--  Line Icon CSS  -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/LineIcons.css" />
<!--  Font Awesome CSS  -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/all.min.css" />
<!-- <link rel="stylesheet" href="https://andrewdoering.org/assets/css/font-awesome.min.css" /> -->
<!--  Animate CSS  -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/animate.css" /> 
<!--  Magnific Popup CSS  -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/magnific-popup.css" />
<!--  Owl-carousel CSS  -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/owl.carousel.min.css" />
<!--  Custom Style CSS  -->
<link rel="stylesheet" href="https://andrewdoering.org/assets/css/style-custom.css" />

        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66440601-3"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66440601-3');
</script>
        
        <style>
            .hero-bg {
              background-image: url("/assets/blog/2020/09/mongodb_logo.png")
            }
        </style>
    </head>

    <body data-spy="scroll" data-target="#scrollspy" data-offset="61" class="pt-hero">
        <!--    Header Start    -->
<header id="header" class="header page-header bg-white fixed-top">
    <nav id="scrollspy" class="navbar navbar-expand-lg header-nav">
        <div class="container">
            <a class="navbar-brand font-weight-bold text-dark" href="https://andrewdoering.org/">
                <span>Andrew Doering</span>
            </a>
            
            <!--  Navbar Toggler Button Start -->
            <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#toggle-menu" aria-controls="toggle-menu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="lni-menu size-md"></span>
            </button>
            
            <!--  Navbar Toggler Button End -->
            <div class="collapse navbar-collapse" id="toggle-menu">
                <ul class="navbar-nav nav-pills ml-auto">
                    <li class="nav-item">
                        <li><a class="nav-link text-dark" href="/blog/categories">Categories & Tags</a></li>
                         <li><a class="nav-link text-dark" href="/blog">Back to Blog</a></li>
                        
                        
                        
                    </li>
                </ul>
            </div> 
        </div>
    </nav>
</header>
<!--    Header End    -->

        <!--    Header End    -->

        <!--    Hero Start    -->
        <a class="color-scheme text-white bg-base-color d-inline-block" href="javascript:void(0)"><i class="lni-night text-white"></i><span class="text-white">Dark</span></a>
<a class="color-scheme color-scheme-light text-white bg-base-color d-none" href="javascript:void(0)"><i class="lni-sun text-white"></i><span class="text-white">Light</span></a>
        <section class="hero hero-bg page-hero py-6" id="hero">
            <div class="text-center hero-content mx-auto">
                <h1 class="text-white center mb-4 col-lg-8" style="margin=4px">Authorizing MongoDB Atlas users against Okta's LDAP Groups</h1>
                <p class="mx-auto text-white">
                    <a href="/" class="text-white">Home</a>
                    /
                    <a href="/blog" class="text-white">Blog</a>
                    /
                    <a href="/blog/2020/09/22/authorizing-mongodb-atlas-users-against-oktas-ldap-groups/" class="text-white">Authorizing MongoDB Atlas users against Okta's LDAP Groups</a>
                </p>
            </div>
        </section>
        <!--    Hero End    -->

        <!--   Blog-single   Start -->
        <section class="py-6">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 blog">
                        <div class="rounded px-lg-1">
                            <div class="text-md-left">
                                <h4 class="mb-4 text-centered" >Authorizing MongoDB Atlas users against Okta's LDAP Groups</h4>
                                <img src="/assets/blog/2020/09/mongodb_logo.png" alt="" class="img-fluid w-100 rounded">
                                <span class="d-inline-block py-4"> Published: Sep 22, 2020 
                                                                                
                                            / Last updated: Nov 19, 2020
                                        
                                        / By <span class="purple-color text-right"> Andrew Doering. </span>
                                        </span>
                                <p class="link-"><ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#issue">Issue</a></li>
  <li><a href="#solution">Solution</a></li>
  <li><a href="#update-20201117">Update 2020/11/17</a></li>
  <li><a href="#update-20201119">Update 2020/11/19</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>As could be understood by my recent blog postings, we have been migrating to an Okta LDAP entry point as our primary LDAP service. Working towards a Cloud Centric first expectation. As could be imagined, there have been some issues popping up while moving infrastructure and making necessary changes. This describes one of these issues. One of these issues was the way that MongoDB Atlas handled LDAP look ups during the authorization process.</p>

<h1 id="issue">Issue</h1>

<p>When running MongoDB Versions equal to or lower than, 3.6.19, 4.0.20, 4.2.9 and using the Mongo <code class="language-plaintext highlighter-rouge">Query Template</code> for Authorization on LDAP Interface :</p>

<p><code class="language-plaintext highlighter-rouge">ou=groups,dc=&lt;okta-instance-id&gt;,dc=okta,dc=com??sub?(&amp;(objectClass=groupofUniqueNames)(uniqueMember={USER}))</code></p>

<p>We would receive failed messages in the shell for MongoDB Atlas. While on the Okta side, we saw several rate limit messages.</p>

<p>MongoDB did group lookups in an inefficient way due to excluding the <code class="language-plaintext highlighter-rouge">DN</code> value and/or specifying a specific <code class="language-plaintext highlighter-rouge">CN</code> value from the lookup and attempting to broadly search for a single user within the group that the lookup is being performed on. Binding on every attempt to make a connection to Okta’s LDAP Interface. Effectively hammering Okta’s LDAP server - which has API limitations <a href="https://developer.okta.com/docs/reference/rate-limits/">outlined here</a>. There was an <a href="https://jira.mongodb.org/browse/SERVER-43233">issue</a> present on MongoDB’s public facing issue tracker (however, not realizing this before hand - we would never have known to look through 47968+ potential issues.)</p>

<p>We reached out to Okta to request an increase to the API limit in the mean time while continuing to test around the issue which they performed on the following:</p>

<p><code class="language-plaintext highlighter-rouge">/api/v1/users/{id}/groups | READ / WRITE | EXACT_MATCH | 1000 / minute</code></p>

<p>However, even with the API increase, we still ended up running into events in the Okta System Log resulting in group lookups not being completed due to rate limiting, and on the MongoDB/Authorization side - failed authorization results.</p>

<p>We ultimately raised a ticket internally with MongoDB Support, to ask if back porting the fix introduced into 4.4.* would be possible, however there was not an ETA at the present time.</p>

<h1 id="solution">Solution</h1>

<p>After several weeks of waiting for the issue to be back ported. It finally has! Beginning with MongoDB Atlas Versions 3.6.20, 4.0.21, and 4.2.10 you can use Okta’s LDAP Interface Okta mastered Groups for Authorization.</p>

<p>The comments written directly by the PoC in charge of the incident filed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>    Please note that in order to utilize the Okta-optimized codepath, you MUST request the DN attribute in the authorization query explicitly.

    Here's the example configuration (swap the `yourdomain` below to your okta tenant domain, as well as be aware of the `your_service_account` ):


    LDAP server: yourdomain.ldap.okta.com
    Server Port: 636
    Bind Username: uid=your_service_account@domain.tld,dc=yourdomain,dc=okta,dc=com
    User To DN Mapping: [ { "match": "(.+)", "substitution": "uid={0},ou=users,dc=yourdomain,dc=okta,dc=com" } ]
    Query Template: ou=groups,dc=yourdomain,dc=okta,dc=com?dn?one?(&amp;(objectClass=groupofUniqueNames)(uniqueMember={USER}))
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Once configured, you should be able to use Okta’s LDAP Interface in MongoDB Atlas and have successful Authorization results!</p>

<h1 id="update-20201117">Update 2020/11/17</h1>

<p>After writing and utilizing this more. We ran into issues with Mongo Compass, connecting to Mongo Atlas with Okta as the backend through the LDAPi. These issues are not present with mongo cli tools.</p>

<p>After doing a decent amount of research and requesting Splunk logs from Okta, we came to the conclusion that Mongo logs out after each request/connection/session initiated. They do not keep a constant session open while the Compass software is connected to the clusters.</p>

<p>In addition to this, instead of doing a single request to the cluster, multiple requests are made (usually 1 to 2) to each shard. The end result is that this spams the end user with (4 - 8) MFA requests.</p>

<p>Our Company Default Okta authentication policy are already setup in a relaxed way:</p>

<ul>
  <li>7 days for a known factor session</li>
  <li>2 hour session lifetime</li>
  <li>Prompt Mode in “per session” choice</li>
</ul>

<p>When going through Mongo support, they requested us to change Prompt Mode from “Per Session” to “Per Device”. This wouldn’t be very effective, as “Per Device” relies mostly on <a href="https://help.okta.com/en/prod/Content/Topics/Security/improved-new-device-behavior-detection.htm">session cookies or device context</a>. Leaving the issue still present with no fix as of writing the update.</p>

<p>So far we are waiting for this to proceed on Mongo, and have opened up a case with Okta to potentially resolve this going forward. For references if anyone else experiences similar issues:</p>

<ul>
  <li>Mongo Case is: <code class="language-plaintext highlighter-rouge">00693506</code></li>
  <li>Okta case is: <code class="language-plaintext highlighter-rouge">00992849</code></li>
</ul>

<p>If you would like to or prefer to reach out to the vendors for potential solutions if I don’t post them here. Or leave a comment below.</p>

<h1 id="update-20201119">Update 2020/11/19</h1>

<p>MongoDB provided an update to us to use the following connection URI:</p>

<p><code class="language-plaintext highlighter-rouge">mongodb+srv://ldapuser:str0ngpassword@mymongo.xxx.xxx/test?authMechanism=PLAIN&amp;maxPoolSize=1&amp;readPreference=secondary&amp;authSource=%24external&amp;appname=MongoDB%20Compass&amp;ssl=false</code></p>

<p>This does seem to work, notice the addition of <code class="language-plaintext highlighter-rouge">&amp;maxPoolSize=1</code>, but, there are two concerns that I have with this:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&amp;ssl=false</code></li>
  <li>What limitations/implications does the addition of the value above have on the overall performance on mongo compass?</li>
</ul>

<p>Initial reactions would be that Compass may not display/return all results within the cluster, as they may not have replicated over to the connected shard instance. I tested initially with <code class="language-plaintext highlighter-rouge">&amp;ssl=true</code> without any major issue, so it seems like that the <code class="language-plaintext highlighter-rouge">&amp;ssl=false</code> aspect may just be an error/mistype.</p>

<p>While I would consider this a workaround for the time being, there are definitely improvements that need to be made into the outbound LDAP requests being made on the Mongo side, or alternatively, Okta needs to implement more flexibility around the LDAP Interface itself.</p>
</p>
                                
                                    
                                        <div id="disqus_thread"></div>
<script>

var disqus_config = function () {
this.page.url = "https://andrewdoering.org/blog/2020/09/23/authorizing-mongodb-atlas-users-against-oktas-ldap-groups";  
this.page.identifier = "authorizing-mongodb-atlas-users-against-oktas-ldap-groups"; 
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://andrewdoering-org.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
                                    
                                

                            </div>
                        </div>
                    </div>
                </div>
            </div>
                
        </section>
        
        <!--   Blog-Single End  -->


        <!--   Footer Start  -->
<footer class="bg-dark">
    <div class="container">
        <div class="row py-5">
            <div class="col-lg-4">
                <h4 class="text-white mt-3 mt-lg-0">About <span class="base-color"> Me</span></h4>
                <p class="text-white pt-3 mb-0">Andrew Doering resides in San Francisco, and currently maintains a position at
                    ThousandEyes as a Senior IT Engineer. </p>
            </div>
            <div class="col-lg-4">
                <h4 class="text-white mt-3 mt-lg-0">Contact <span class="base-color">Me</span></h4>
                <ul class="list-unstyled text-white pt-2 mb-0">
                    <li class="py-1"><i class="fas fa-map-marker-alt pr-2"></i> San Francisco, CA, USA</li>
                    <li class="py-1"><a class="text-white link-hover" href="tel:+1 919 904 4396"><i class="fas fa-phone-square-alt pr-2" aria-hidden="true"></i>
                        +1 919 904 4396</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="mailto:contact@andrewdoering.org"><i class="fas fa-envelope pr-2 pr-2" aria-hidden="true"></i>
                        contact@andrewdoering.org</a></li>        
                </ul>
            </div>
            <div class="col-lg-4">
                <h4 class="text-white mt-3 mt-lg-0">My <span class="base-color">Socials</span></h4>
                <ul class="list-unstyled text-white socials pt-2 mb-0">
                    <li class="py-1"><a class="text-white link-hover" href="https://www.facebook.com/and.doe"><i class="fab fa-facebook-f pr-2" aria-hidden="true"></i>
                            Facebook</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.linkedin.com/in/andrewdoering"><i class="fab fa-linkedin pr-2"
                                aria-hidden="true"></i> LinkedIn</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.github.com/delize"><i class="fab fa-github pr-1" aria-hidden="true"></i>
                            Github</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.instagram.com/dolos01"><i class="fab fa-instagram pr-2" aria-hidden="true"></i>
                            Instagram</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="skype:andrew-doering"><i class="fab fa-skype pr-2" aria-hidden="true"></i> andrew-doering</a>
                    </li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.macadmins.org/"><i class="fab fa-slack pr-2" aria-hidden="true"></i> @heimdall</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="row">
                <div class="col-lg-12 border-top pb-5 align-center">
                    <a class="text-white link-hover" href="https://www.github.com/delize/delize.github.io"><span class="mt-3 mb-0 d-lg-inline-block align-left text-center text-white link-hover d-block d-lg-inline-block float-lg-left">See me on Github © 2021</span></a>
                    <a class="text-white link-hover" href="/donate"><span class="mt-3 mb-0 d-lg-inline-block align-center d-block text-white link-hover">Donate!</span></a>
                <a class="mt-4 mt-lg-3 mb-0 text-white back-to-top d-block d-lg-inline-block float-lg-right text-center" href="javascript:void(0);">Back To Top</a>
            </div>
        </div>
    </div>
</footer>
<!--   Footer End  -->
        <!--  JavaScripts  -->
<script src=https://andrewdoering.org/assets/js/jquery-3.4.1.min.js></script>
<!--  Bootstrap Js  -->
<!-- <script src="assets/js/bootstrap.js"></script> -->
<script src=https://andrewdoering.org/assets/js/bootstrap.min.js></script>
<!--  Easing Js  -->
<script src=https://andrewdoering.org/assets/js/jquery.easing.min.js></script>
<!--  Isotope Js  -->
<script src=https://andrewdoering.org/assets/js/slyslider.js></script>
<!--  Pop UP JS Js  -->
<script src=https://andrewdoering.org/assets/js/jquery.magnific-popup.min.js></script>
<!--  Owl carousel Js  -->
<script src=https://andrewdoering.org/assets/js/owl.carousel.min.js></script>
<!--  Wow Js  -->
<script src=https://andrewdoering.org/assets/js/wow.min.js></script>
<!--  Typed Js  -->
<script src=https://andrewdoering.org/assets/js/typed.js></script>
<!--  Custom JS  -->
<script src=https://andrewdoering.org/assets/js/uone.js></script>


    </body>
</html>
